[Unit]
Description=Phoenix Real Estate LLM Processing Service
Documentation=https://github.com/phoenix-real-estate/collector
After=network-online.target mongodb.service ollama.service
Wants=network-online.target
Requires=mongodb.service ollama.service

[Service]
Type=simple
User=phoenix
Group=phoenix
WorkingDirectory=/opt/phoenix-real-estate

# Environment variables
EnvironmentFile=/etc/phoenix-real-estate/.env.production
Environment="PATH=/opt/phoenix-real-estate/.venv/bin:/usr/local/bin:/usr/bin:/bin"
Environment="PYTHONPATH=/opt/phoenix-real-estate/src"
Environment="PHOENIX_ENV=production"

# Python virtual environment
ExecStartPre=/opt/phoenix-real-estate/.venv/bin/python -m phoenix_real_estate.collectors.processing.service --health-check
ExecStart=/opt/phoenix-real-estate/.venv/bin/python -m phoenix_real_estate.collectors.processing.service

# Restart configuration
Restart=always
RestartSec=5
StartLimitInterval=600
StartLimitBurst=5

# Process management
KillMode=mixed
KillSignal=SIGTERM
TimeoutStopSec=30

# Resource limits
LimitNOFILE=65536
MemoryLimit=3G
MemoryAccounting=true
CPUAccounting=true
CPUQuota=200%

# Timeouts
TimeoutStartSec=300

# Security hardening
NoNewPrivileges=true
PrivateTmp=true
ProtectSystem=strict
ProtectHome=true
ProtectKernelTunables=true
ProtectKernelModules=true
ProtectControlGroups=true
RestrictAddressFamilies=AF_INET AF_INET6 AF_UNIX
RestrictNamespaces=true
LockPersonality=true
MemoryDenyWriteExecute=true
RestrictRealtime=true
RestrictSUIDSGID=true
RemoveIPC=true

# Read-write paths
ReadWritePaths=/var/log/phoenix_real_estate
ReadWritePaths=/var/lib/phoenix_real_estate
ReadWritePaths=/tmp/phoenix_llm

# Logging
StandardOutput=journal
StandardError=journal
SyslogIdentifier=phoenix-llm-processor

[Install]
WantedBy=multi-user.target